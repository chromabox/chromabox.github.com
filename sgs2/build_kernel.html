<!--?xml version="1.0" encoding="UTF-8"?-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html
  xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja">
  <head>
    <meta http-equiv="content-language" content="ja">
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <link rel="start index" href="./">
    <title>GalaxyS 2 (GT-I9100) 公式カーネルのコンパイル方法</title>
  </head>
  <body>
    <h2>GalaxyS 2 (GT-I9100) 公式カーネルのコンパイル方法</h2>
    <p> 自分用メモなので無保証。<br>
      正式版ではコンフィグ変わってたりBugfixされていたりソース違うかもしれません。<br>
      わかる人だけ参考にしてください。<br>
      <br>
      はなくろ様の<a href="http://blog.8796.jp/8796kanri/2011/05/%e9%9b%bb%e8%a9%b1-galaxy-sii-gt-i9100%e3%81%ae%e3%82%ab%e3%83%bc%e3%83%8d%e3%83%ab%e3%82%92%e6%89%8b%e6%97%a9%e3%81%8f%e3%83%93%e3%83%ab%e3%83%89%e3%81%99%e3%82%8b.html">ペー
        ジ</a>を参考にしました。 今回はとりあえずビルドだけ。<br>
      まだ実機も無いし今後変わる可能性が高い。<br>
      <br>
      <br>
    </p>
    <hr checked="true">
    <h4>１．カーネルをさむそんから落とす</h4>
    <a href="https://opensource.samsung.com/">https://opensource.samsung.com/</a>
    から落とす。<br>
    <br>
    GT-I9100で検索。なんか５月に更新されたらしい。 <br>
    <br>
    <br>
    <hr checked="true">
    <h4>２．落としたカーネルソースともども展開する </h4>
    <br>
    <hr checked="true">
    <h4>３．コンパイラをどこかに展開。</h4>
    コンパイラはSourcery G++ Lite 2009q3-68 for ARM EABIを使う <br>
    <a href="http://www.codesourcery.com/sgpp/lite/arm/portal/release1033">http://www.codesourcery.com/sgpp/lite/arm/portal/release1033</a>
    <br>
    <br>
    <hr checked="true">
    <h4>４．moduleをインストールする受け皿ディレクトリを作る </h4>
    <br>
    <hr checked="true">
    <h4>５．パス通すためのなんか適当なシェルスクリプトをこんな感じで作る </h4>
    <br>
    <code>$ touch env.sh<br>
      $ vi env.sh <br>
    </code><br>
    などとして作るべし。 <br>
    <br>
    参考例：<br>
    <br>
    <code>#!/bin/bash <br>
      <br>
      export PATH=/opt/android/sgs2/toolchains/arm-2009q3/bin:$PATH <br>
      export ARCH=arm <br>
      export CROSS_COMPILE=arm-none-eabi- <br>
      export INSTALL_MOD_PATH=/opt/android/sgs2/fstemp <br>
      <br>
      echo "Set Samsung GalaxyS II (GT-I9100) arm-none-eabi-gcc ver
      4.4.1 with Linux 2.6.35" </code><br>
    <br>
    (LOCALVERSIONとか、KBUILD_BUILD_VERSIONはお好みでexportすればよろし)<br>
    <br>
    作ったらこういう感じで環境をセットする <br>
    <br>
    <code>$ chmod +x env.sh <br>
      $ . ./env.sh </code><br>
    <br>
    <hr checked="true">
    <h4>６．カーネルのディレクトリに行ってから </h4>
    <br>
    <code>$ make c1_rev02_jpn_ntt_defconfig <br>
      $ make <br>
      $ make modules <br>
      $ make modules_install </code><br>
    <br>
    (日本版は多分c1_rev02_jpn_ntt_defconfig。国際版はc1_rev02_defconfigだと思う。コンフィグは
    arch/arm/configsに色々入っているので覗いてみると良いです)<br>
    <br>
    でOK。 <br>
    <br>
    arch/arm/boot/にzImageが出来ているのでこれがカーネルの純粋なイメージとなる。<br>
    <br>
    # make -j4 とかまぁその辺は適切に。 <br>
    # make modules は、なんかmakeの最後のほうに勝手にやるのでいらんかも<br>
    # make modules_installは、受け皿 /opt/android/sgs2/fstemp
    に.ko（ドライバたち）がコピーされる<br>
    <br>
    <hr checked="true">
    <h4>７．とりあえず何処からかinitramfsの大元をどこからか取得する。</h4>
    XDAの使ったほうがよいかも。<br>
    <br>
    <a checked="true" href="https://github.com/GalaxySII/initramfs-galaxysii">https://github.com/GalaxySII/initramfs-galaxysii</a>&nbsp;


    ：特になにもいじっていないinitramfs。<br>
    <a href="https://github.com/project-voodoo/galaxysii-initramfs-modified">https://github.com/project-voodoo/galaxysii-initramfs-modified</a>&nbsp;


    ：suとsuperuser.apkが初期にコピーされるようになってる<br>
    &nbsp; <br>
    <br>
    <hr checked="true">
    <h4>８．initramfsにさっき作ったドライバをコピーする </h4>
    <code>$ cd fstemp<br>
      $ find -name '*.ko' -exec cp -av {} ../initramfs_mod/lib/modules/
      \;</code><br>
    <br>
    <hr checked="true">
    <h4>９．cpioでinitamfsの元を固める</h4>
    <code>$ su <br>
      # cd initramfs_mod <br>
      # find | cpio -H newc -o &gt; ../initramfs_mod.cpio 2&gt;/dev/null
      # exit </code><br>
    <br>
    (fakerootがある場合はsu使わなくてもいい)<br>
    <br>
    <hr checked="true">
    <h4>１０．再びカーネルをコンパイル。 </h4>
    一度コンパイルしたのであとはzImageにくっ付ける作業をするだけ<br>
    <br>
    <code>$ cd kermel <br>
      $ make zImage CONFIG_INITRAMFS_SOURCE="../initramfs_mod.cpio" </code><br>
    <br>
    <br>
    <hr checked="true">
    <h4>１１．arch/arm/bootにzImageがあるのでTARして終わり</h4>
    <code>$ tar cvf GT-I9100_kernel_Gingerbread_homebrew.tar zImage </code><br>
    <br>
    <br>
    <hr checked="true">↑の一連操作が面倒な人はこのスクリプト(<a href="build_kernel.sh">build_kernel.sh</a>)
    をつかうとよいかも。<br>
    <br>
    使いかたは次の通り。<br>
    <br>
    前提：<br>
    クロスコンパイラ、カーネル、initramfsの素は取得して適切な場所に展開しておいてください。<br>
    <br>
    注意：<br>
    実行する前に<a href="build_kernel.sh">build_kernel.sh</a>を適時環境に合わせて書き換えてくだ
    さい。<br>
    <br>
    パスやファイル名はフルパスで設定してください。<br>
    <br>
    KCONFIGNAME ： 大元となるカーネルのコンフィグ名。<br>
    TAR_NAME： 最終的に生成されるTAR名<br>
    INITRAMFS_DIR： initramfsの素をコピーしておいたディレクトリ名<br>
    KMODPATH： カーネルモジュールパス。作業用なので適当に<br>
    KERNELPATH： カーネルのパス<br>
    TOOLCHAINPATH： コンパイラ（ツールチェイン）へのパス<br>
    <br>
    以下はお好みで<br>
    <br>
    LOCALVERSION ローカルバージョン名。カーネルバージョンの後ろにくっつきます。<br>
    KBUILD_BUILD_VERSION 同じく<br>
    <br>
    設定しおえたら<br>
    $ ./build_kernel.sh<br>
    として実行。<br>
    すると、<br>
    choose:<br>
    1: default jpn config kernel and build<br>
    2: default jpn config and reconfig kernel and build<br>
    3: reconfig kernel and build<br>
    4: no config kernel and build<br>
    と出てくるので、数字キーを押してリターンしてください。<br>
    <br>
    よくわからんかったら１でOKです。<br>
    <br>
    一応説明すると<br>
    １：デフォルトのJPNコンフィグを使ってカーネルとinitramfsをビルドします。<br>
    ２：デフォルトのJPNコンフィグを使って一度menuconfigでコンフィグ画面を出した後、カーネルとinitramfsをビルドします。<br>
    ３：カーネルディレクトリに残っているコンフィグを使ってmenuconfigでコンフィグ画面を出した後、カーネルとinitramfsをビル
    ドします。<br>
    ４：カーネルディレクトリに残っているコンフィグを使ってカーネルとinitramfsをビルドします。（要はリビルド）<br>
    <br>
    （一度cleanをしてからビルドするのでcleanが困る人はmake cleanの項目をコメントアウトしてください）<br>
    <br>
    で、うまくいったら最後に<br>
    done.<br>
    と出てきてTARが出来ているはずです。<br>
    <br>
    <br>
    <br>
    <br>
    <hr checked="true">謎１： <br>
    <br>
    XDAの某スクリプトでは <br>
    <code>export
      CROSS_COMPILE=/opt/toolchains/arm-2009q3/bin/arm-none-linux-gnueabi-
    </code><br>
    となっていた。<br>
    しかし公式のREADMEではEABI版を使えとなっていた。どちらが正しいかは実機がないので謎。<br>
    linux-gnueabiは本来Linux用プロセスを作るときのためにlinkerscriptとかが調整されてたと思う<br>
    素のeabiはOS関係なしのガチな組み込み用で、カーネルビルドのときはincludeもlinkもカーネルのを使うようになってたはずなので
    結果は一緒かな。。。<br>
    <br>
    謎２： <br>
    <br>
    EUR版（国際版）ではGZIPで圧縮されるけど日本版では <br>
    <code>CONFIG_KERNEL_LZO=y</code><br>
    なので、LZOみたい。<br>
    日本版のブートローダがLZOしか受け付けなかったらちょっと面倒かもしれない？<br>
    (バイナリエディタでみたけどLZOのシグネチャが入ってるので多分。。)<br>
    ブートを若干早くしたいためなのかな？<br>
    <br>
    <br>
    <code><code><code><code><code><code><code><code><code><code><code><code><code><code><code><code><br>
                                  </code></code></code></code></code></code></code></code></code></code></code></code></code></code></code></code>
  </body>
</html>
